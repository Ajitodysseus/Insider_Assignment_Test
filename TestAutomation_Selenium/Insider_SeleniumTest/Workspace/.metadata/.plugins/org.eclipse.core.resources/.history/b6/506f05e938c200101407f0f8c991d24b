package Implementation;

import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.Base64;
import java.util.Properties;
import org.testng.annotations.Test;
import org.testng.asserts.SoftAssert;

import PO.BCSDATA.LoginPage_Po;
import PO.BCSDATA.OpenInsiderApp_Po;
import PO.CommonFunctionality.BaseClass;
import PO.CommonFunctionality.CommonBaseFuctions;
import PO.CommonFunctionality.CommonFunctions;
import Utility.configuration.ConfigReader;
import junit.framework.Assert;

public class InsiderApp_Test extends BaseClass {

	CommonFunctions cf = new CommonFunctions();
	CommonBaseFuctions cb;
	String uname;
	String pass;
	boolean TestStepStatus;

	@Test(priority = 1)
	public void Insider_HomePage() throws InterruptedException, IOException {

		try {
			// Load properties
			ConfigReader.loadConfig();
			properties = ConfigReader.properties;

			if (properties.getProperty("LaunchApplication").equalsIgnoreCase("True")) {
				
				OpenInsiderApp_Po oi = new OpenInsiderApp_Po(driver);

				cf.Info("Visit https://useinsider.com/ and check Insider home page is opened or not.");

				String URL = properties.getProperty("Test_URL");
				driver.get(URL);
				Thread.sleep(2000);

				TestStepStatus = oi.Validate_Application();
				Thread.sleep(2000);
				cf.TestStepStatus("The Insider Application is opened successfully.", TestStepStatus);

			}

		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	@Test(priority = 2)
	public void Select_And_Validate_CompanyMenu() throws InterruptedException {

		try {

			if (properties.getProperty("Dashboard").equalsIgnoreCase("True")) {

				LoginPage_Po lp = new LoginPage_Po(driver);

				String URL = properties.getProperty("V4url");
				driver.get(URL);
				Thread.sleep(2000);
				cf.pass("Launch Downtime Application");

				uname = properties.getProperty("AdminUsername");
				pass = properties.getProperty("AdminPassword");

				String decryptedPassword = getDecryptedPassword(pass);

				TestStepStatus = lp.login_into_app_with_admin_role(uname, decryptedPassword);
				Thread.sleep(2000);
				cf.TestStepStatus("Login into application with Admin role", TestStepStatus);
			}

			driver.close();
			driver.quit();
			Thread.sleep(1000);

		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	private static String getDecryptedPassword(String pass) {
		if (!isEncrypted(pass)) {
			return pass; // plain text password
		}
		return decrypt(pass);
	}

	private static boolean isEncrypted(String data) {
		try {
			byte[] decoded = Base64.getDecoder().decode(data);
			return new String(decoded).matches("^[a-zA-Z0-9@#._-]+$");
		} catch (Exception e) {
			return false;
		}
	}

	public static void saveEncryptedCredentials() {

		String propertiesFilePath = properties.getProperty("PropertyPath");

		try {

			Properties properties = new Properties();
			FileInputStream inStream = new FileInputStream(propertiesFilePath);
			properties.load(inStream);

			String password = properties.getProperty("AdminPassword");

			if (isEncrypted(password)) {
				System.out.println("Value is already encrypted.");
				System.out.println("Decrypted value: " + decrypt(password));
			} else {
				System.out.println("Value is not encrypted.");
				String encryptedValue = encrypt(password);

				properties.setProperty("AdminPassword", encryptedValue);

				FileOutputStream outStream = new FileOutputStream(propertiesFilePath);
				properties.store(outStream, "Encrypted Credentials");
				outStream.close();
			}

		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	public static String encrypt(String value) {
		return Base64.getEncoder().encodeToString(value.getBytes());
	}

	public static String decrypt(String encryptedValue) {
		return new String(Base64.getDecoder().decode(encryptedValue));
	}
}
